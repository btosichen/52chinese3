import React, { useState, useEffect } from 'react';
import { Sun, BookOpen, PenTool, Youtube, Award, UploadCloud, History, ArrowRight, RotateCcw, Check, X } from 'lucide-react';

const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_F94zepYjcV61hjVBmFWQZ6Ykh5Y2uMUbyuAdUOZtpL2fMTa4_GOCpu_iDCddhX35/exec";

// --- æ³¨å…¥è‡ªå®šç¾©æ¨£å¼ ---
const GlobalStyles = () => (
    <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #FFF9C4 0%, #DCEDC8 50%, #B3E5FC 100%);
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
        }
        
        /* è¶…å¼·è¨˜æ†¶æ³•é¡è‰²å®šç¾© */
        .mem-yellow { color: #F57F17; background-color: #FFF9C4; padding: 2px 8px; border-radius: 8px; font-weight: bold; } /* ä¸»æ—¨ */
        .mem-blue { color: #0277BD; border-bottom: 4px solid #81D4FA; font-weight: bold; } /* ç”Ÿå­—è©èª */
        .mem-green { color: #2E7D32; font-style: italic; background-color: #E8F5E9; padding: 2px 8px; border-radius: 8px;} /* æ„Ÿå— */
        .mem-red { color: #C62828; border: 2px dashed #EF9A9A; padding: 2px 6px; border-radius: 8px; font-weight: bold; } /* ä¿®è¾­ */

        /* å‹•ç•«æ•ˆæœ */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .animate-spin-slow { animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .bounce { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

        /* å¤§å­—é«”å„ªåŒ– */
        .text-huge { font-size: clamp(2rem, 5vw, 3rem); line-height: 1.2; }
        .text-big { font-size: clamp(1.5rem, 4vw, 2.25rem); line-height: 1.4; }
        .text-med { font-size: clamp(1.2rem, 3vw, 1.75rem); line-height: 1.5; }
        
        /* äº’å‹•æŒ‰éˆ• */
        .btn-interact {
            transition: all 0.2s;
            box-shadow: 0 6px 0 #666;
            transform: translateY(0);
        }
        .btn-interact:active {
            box-shadow: 0 0 0 #666;
            transform: translateY(6px);
        }
    `}</style>
);

// --- èª²ç¨‹è³‡æ–™ ---
const lessonContent = [
    {
        type: 'keypoint',
        title: 'èª²æ–‡é‡é» 1ï¼šé™½å…‰çš„ç§˜å¯†',
        icon: 'â˜€ï¸',
        content: (
            <div className="text-big text-center">
                <span className="mem-yellow">é™½å…‰ä¸åªæ˜¯å…‰</span>ï¼Œå®ƒä¹Ÿæœ‰
                <br/><br/>
                <span className="mem-green">é¡è‰²ã€é¦™æ°£ã€æ»‹å‘³</span>
            </div>
        ),
        tip: 'è¨˜æ†¶å£è¨£ï¼šè‰²é¦™å‘³ä¿±å…¨çš„é™½å…‰'
    },
    {
        type: 'keypoint',
        title: 'èª²æ–‡é‡é» 2ï¼šæƒ³åƒåŠ›çš„é­”æ³•',
        icon: 'ğŸŒˆ',
        content: (
            <div className="text-big text-center">
                ä½œè€…ç”¨<span className="mem-red">æƒ³åƒåŠ›</span>ï¼ŒæŠŠ
                <br/>
                çœ‹ä¸è¦‹çš„é™½å…‰ï¼Œè®Šå¾—åƒ
                <br/>
                <span className="mem-yellow">æ°´æœä¸€æ¨£å…·é«”</span>
            </div>
        ),
        tip: 'æŠŠæŠ½è±¡è®Šå…·é«”ï¼šå…‰ -> æ°´æœ'
    },
    {
        type: 'keypoint',
        title: 'èª²æ–‡é‡é» 3ï¼šé¡è‰²çš„è±¡å¾µ',
        icon: 'ğŸ¨',
        content: (
            <div className="text-big text-center">
                é¡è‰²å­—ä¸åªä»£è¡¨é¡è‰²ï¼Œ
                <br/>
                ä¹Ÿä»£è¡¨<span className="mem-green">å¿ƒæƒ…æˆ–æ„Ÿå—</span>ã€‚
                <br/><br/>
                ä¾‹å¦‚ï¼š<span className="mem-blue">é‡‘é»ƒè‰²</span> = æº«æš–ã€æˆç†Ÿ
            </div>
        ),
        tip: 'çœ‹åˆ°é¡è‰² -> æƒ³åˆ°å¿ƒæƒ…'
    }
];

// --- é¡Œåº« ---
const quizData = [
    {
        id: 1,
        type: 'choice',
        question: 'ä¼¯ä¼¯çš„è‡‰è‰²çœ‹èµ·ä¾†åƒèŠ­æ¨‚é‚£éº¼____ã€‚',
        options: ['ç¶ ', 'éŒ„'],
        answer: 'ç¶ ',
        explanation: 'ã€Œç¶ ã€è‰²æ˜¯é¡è‰²ï¼›ã€ŒéŒ„ã€éŸ³æ˜¯å‹•ä½œã€‚',
        category: 'åœ‹å­—è¾¨è­˜'
    },
    {
        id: 2,
        type: 'choice',
        question: 'ã€Œé’æ¾€ã€çš„æ­£ç¢ºæ³¨éŸ³æ˜¯ï¼Ÿ',
        options: ['ã„‘ã„§ã„¥ ã„™ã„œË‹', 'ã„‘ã„§ã„¥ ã„•ã„œË‹'],
        answer: 'ã„‘ã„§ã„¥ ã„™ã„œË‹',
        explanation: 'æ¾€ (ã„™ã„œË‹) åªæœ‰ä¸€å€‹è®€éŸ³å–”ï¼',
        category: 'æ³¨éŸ³ç·´ç¿’'
    },
    {
        id: 3,
        type: 'boolean',
        question: 'ä½œè€…çœŸçš„çœ‹åˆ°é™½å…‰æ˜¯ç¶ è‰²çš„å—ï¼Ÿ',
        options: ['â—‹ (æ˜¯çœŸçš„)', 'âœ• (æ˜¯æƒ³åƒ)'],
        answer: 'âœ• (æ˜¯æƒ³åƒ)',
        explanation: 'é€™æ˜¯ä½œè€…é€éæ¨¹è‘‰æ„Ÿå—åˆ°çš„ã€Œæƒ³åƒã€ç•«é¢ã€‚',
        category: 'èª²æ–‡ç†è§£'
    },
    {
        id: 4,
        type: 'drag', // Simplified as matching choice for UI stability
        question: 'ã€Œé™½å…‰åƒé‡‘è‰²çš„å¤§ç¶²ã€é‹ç”¨äº†å“ªç¨®ä¿®è¾­ï¼Ÿ',
        options: ['æ“¬äºº', 'è­¬å–»', 'è¨­å•'],
        answer: 'è­¬å–»',
        explanation: 'æœ‰ã€Œåƒ...ã€å°±æ˜¯è­¬å–»æ³•ã€‚',
        category: 'ä¿®è¾­æŠ€å·§'
    },
    {
        id: 5,
        type: 'choice',
        question: 'ã€Œèªªä¸å®šæ˜¯ç¶ æ²¹æ²¹çš„å§ï¼Ÿã€é€™å¥è©±æ˜¯ï¼Ÿ',
        options: ['è¨­å•', 'æ“¬äºº'],
        answer: 'è¨­å•',
        explanation: 'å¿ƒä¸­æœ‰ç–‘å•ï¼Œæˆ–æ˜¯è‡ªå•è‡ªç­”ï¼Œå°±æ˜¯è¨­å•ã€‚',
        category: 'ä¿®è¾­æŠ€å·§'
    },
    {
        id: 6,
        type: 'choice',
        question: 'ã€Œæ¸…ç”œã€çš„ç›¸åè©ï¼ˆåç¾©è©ï¼‰æ˜¯ï¼Ÿ',
        options: ['ç”˜ç”œ', 'è‹¦æ¾€'],
        answer: 'è‹¦æ¾€',
        explanation: 'æ¸…ç”œæ˜¯å¥½åƒçš„å‘³é“ï¼Œè‹¦æ¾€æ˜¯ä¸å¥½åƒçš„ã€‚',
        category: 'è©èªé—œä¿‚'
    }
];

// --- å­å…ƒä»¶ ---

const LoginScreen = ({ onLogin }) => {
    const [name, setName] = useState('');
    return (
        <div className="flex flex-col items-center gap-8 w-full max-w-lg fade-in">
            <div className="text-huge font-bold text-center text-orange-600">
                æ­¡è¿ä¾†åˆ°<br/>ç¬¬ 3 èª²
            </div>
            <div className="w-full bg-white p-8 rounded-3xl shadow-xl border-4 border-yellow-200">
                <label className="block text-2xl font-bold mb-4 text-gray-700 text-center">è«‹å•ä½ å«ä»€éº¼åå­—ï¼Ÿ</label>
                <input 
                    type="text" 
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    className="w-full p-6 text-3xl text-center border-4 border-blue-200 rounded-2xl focus:border-blue-500 outline-none transition-colors bg-blue-50"
                    placeholder="è¼¸å…¥å§“å"
                />
                <button 
                    onClick={() => onLogin(name)}
                    className="mt-8 w-full bg-green-500 hover:bg-green-600 text-white text-3xl font-bold py-6 rounded-2xl btn-interact flex justify-center items-center gap-3"
                >
                    é–‹å§‹ä¸Šèª² <ArrowRight size={36} />
                </button>
            </div>
        </div>
    );
};

const MainMenu = ({ setView, localHistory, studentName }) => {
    const [showHistory, setShowHistory] = useState(false);
    
    // Filter history for current user only
    const myHistory = localHistory.filter(h => h.name === studentName);

    if (showHistory) {
        return (
            <div className="w-full h-full flex flex-col fade-in">
                 <h2 className="text-4xl font-bold text-center mb-6 text-blue-800">ğŸ“œ {studentName} çš„å­¸ç¿’ç´€éŒ„</h2>
                 <div className="flex-1 overflow-y-auto bg-white rounded-2xl border-4 border-blue-200 p-4 shadow-inner max-h-[60vh]">
                    {myHistory.length === 0 ? (
                        <p className="text-2xl text-center text-gray-400 py-10">é‚„æ²’æœ‰ç´€éŒ„å–”ï¼Œå¿«å»æŒ‘æˆ°ï¼</p>
                    ) : (
                        <table className="w-full text-xl md:text-2xl">
                            <thead className="bg-blue-100 text-blue-800">
                                <tr>
                                    <th className="p-3 text-left">æ™‚é–“</th>
                                    <th className="p-3 text-center">åˆ†æ•¸</th>
                                </tr>
                            </thead>
                            <tbody>
                                {myHistory.map((rec, idx) => (
                                    <tr key={idx} className="border-b border-gray-100">
                                        <td className="p-3 text-gray-600 text-lg">{rec.date.split(' ')[0]} <br/> <span className="text-sm">{rec.date.split(' ')[1]}</span></td>
                                        <td className="p-3 text-center font-bold text-orange-600">{rec.score} åˆ†</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    )}
                 </div>
                 <button onClick={() => setShowHistory(false)} className="mt-6 bg-gray-500 text-white text-2xl py-4 rounded-xl btn-interact">
                    è¿”å›é¸å–®
                 </button>
            </div>
        );
    }

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-3xl fade-in">
            <MenuButton 
                color="bg-red-400" 
                icon={<Youtube size={48} />} 
                title="å½±ç‰‡è§€è³" 
                sub="å¼•å°ã€æœ—è®€ã€ä½œè€…å‹•ç•«"
                onClick={() => setView('video')} 
            />
            <MenuButton 
                color="bg-yellow-400" 
                icon={<BookOpen size={48} />} 
                title="é‡é»æ•´ç†" 
                sub="è¶…å¼·è¨˜æ†¶æ³•"
                onClick={() => setView('study')} 
            />
            <MenuButton 
                color="bg-green-500" 
                icon={<PenTool size={48} />} 
                title="äº’å‹•æŒ‘æˆ°" 
                sub="æ¸¬é©—èˆ‡å°éŠæˆ²"
                onClick={() => setView('quiz')} 
            />
            <MenuButton 
                color="bg-blue-400" 
                icon={<History size={48} />} 
                title="å­¸ç¿’ç´€éŒ„" 
                sub="æŸ¥çœ‹æˆ‘çš„æˆç¸¾"
                onClick={() => setShowHistory(true)} 
            />
        </div>
    );
};

const MenuButton = ({ color, icon, title, sub, onClick }) => (
    <button 
        onClick={onClick}
        className={`${color} text-white p-8 rounded-3xl btn-interact flex flex-col items-center justify-center gap-4 h-48 md:h-64`}
    >
        <div className="bg-white/20 p-4 rounded-full">{icon}</div>
        <div>
            <div className="text-3xl md:text-4xl font-bold">{title}</div>
            <div className="text-xl opacity-90 mt-1">{sub}</div>
        </div>
    </button>
);

const VideoSection = ({ onBack }) => {
    const [tab, setTab] = useState(0);
    const videos = [
        { title: 'å¼•å°å‹•ç•«', url: 'https://nanivideo-download.oneclass.com.tw/media/ade61c76931ba7f9/video/å¼•å°å‹•ç•«/L03å¼•å°å‹•ç•«_è‰²é¦™å‘³çš„é™½å…‰.mp4' },
        { title: 'èª²æ–‡æœ—è®€', url: 'https://nanivideo-download.oneclass.com.tw/media/ade61c76931ba7f9/video/éš¨æ–‡æœ—è®€å‹•ç•«/L03éš¨æ–‡æœ—è®€å‹•ç•«_è‰²é¦™å‘³çš„é™½å…‰.mp4' },
        { title: 'ä½œè€…å‹•ç•«', url: 'https://nanivideo-download.oneclass.com.tw/media/ade61c76931ba7f9/video/ä½œè€…å‹•ç•«/L03ä½œè€…å‹•ç•«_æ—èŠ³è.mp4' }
    ];

    return (
        <div className="w-full h-full flex flex-col fade-in">
            <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                {videos.map((v, i) => (
                    <button 
                        key={i}
                        onClick={() => setTab(i)}
                        className={`px-6 py-3 rounded-xl text-xl font-bold whitespace-nowrap transition-colors ${tab === i ? 'bg-red-500 text-white shadow-lg' : 'bg-white text-gray-600 border-2 border-gray-200'}`}
                    >
                        {v.title}
                    </button>
                ))}
            </div>
            <div className="flex-1 bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-gray-800">
                <video 
                    key={videos[tab].url}
                    controls 
                    className="w-full h-full object-contain"
                    poster="https://placehold.co/800x450/333/FFF?text=Loading+Video..."
                >
                    <source src={videos[tab].url} type="video/mp4" />
                    ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡æ’­æ”¾
                </video>
            </div>
            <button onClick={onBack} className="mt-6 bg-gray-500 text-white text-2xl py-3 rounded-xl btn-interact w-full">
                è¿”å›é¸å–®
            </button>
        </div>
    );
};

const StudySection = ({ onBack }) => {
    const [page, setPage] = useState(0);

    return (
        <div className="w-full max-w-4xl flex flex-col items-center fade-in">
            <div className="w-full bg-white p-8 md:p-12 rounded-[3rem] shadow-2xl border-b-8 border-yellow-500 min-h-[50vh] flex flex-col items-center justify-center relative">
                <div className="absolute top-6 right-6 text-6xl animate-bounce">
                    {lessonContent[page].icon}
                </div>
                
                <h2 className="text-3xl md:text-4xl font-bold mb-8 text-gray-800 border-b-4 border-yellow-200 pb-2">
                    {lessonContent[page].title}
                </h2>
                
                <div className="mb-10 w-full">
                    {lessonContent[page].content}
                </div>

                <div className="bg-blue-50 border-2 border-blue-200 p-4 rounded-xl w-full text-center">
                    <span className="font-bold text-blue-600 text-xl">ğŸ’¡ è¶…å¼·è¨˜æ†¶å°æ’‡æ­¥ï¼š</span>
                    <p className="text-2xl text-gray-700 mt-2">{lessonContent[page].tip}</p>
                </div>
            </div>

            <div className="flex gap-4 mt-8 w-full">
                <button 
                    onClick={onBack}
                    className="flex-1 bg-gray-400 text-white text-2xl py-4 rounded-2xl btn-interact"
                >
                    å›é¸å–®
                </button>
                <button 
                    onClick={() => setPage((prev) => (prev + 1) % lessonContent.length)}
                    className="flex-[2] bg-yellow-400 text-yellow-900 text-3xl font-bold py-4 rounded-2xl btn-interact flex items-center justify-center gap-2"
                >
                    ä¸‹ä¸€å€‹é‡é» <ArrowRight />
                </button>
            </div>
            
            <div className="mt-4 flex gap-2">
                {lessonContent.map((_, i) => (
                    <div key={i} className={`h-3 w-3 rounded-full ${i === page ? 'bg-yellow-500 scale-125' : 'bg-gray-300'}`}></div>
                ))}
            </div>
        </div>
    );
};

const QuizSection = ({ questions, onComplete, onBack }) => {
    const [idx, setIdx] = useState(0);
    const [feedback, setFeedback] = useState(null); // null, 'correct', 'wrong'
    const [history, setHistory] = useState([]);
    const [currentScore, setCurrentScore] = useState(0);

    const q = questions[idx];

    const handleAnswer = (option) => {
        if (feedback) return; // Prevent double click

        const isCorrect = option === q.answer;
        
        // Sound effect logic could go here
        
        setFeedback(isCorrect ? 'correct' : 'wrong');
        
        // Record
        const newHistory = [...history, { 
            question: q.question, 
            userAns: option, 
            correctAns: q.answer, 
            correct: isCorrect 
        }];
        setHistory(newHistory);
        
        if (isCorrect) setCurrentScore(prev => prev + 100/questions.length); // Simple scoring

        // Delay for next question
        setTimeout(() => {
            setFeedback(null);
            if (idx < questions.length - 1) {
                setIdx(idx + 1);
            } else {
                onComplete(Math.round(isCorrect ? currentScore + 100/questions.length : currentScore), newHistory);
            }
        }, 2000);
    };

    return (
        <div className="w-full max-w-3xl flex flex-col fade-in">
            {/* Progress Bar */}
            <div className="w-full bg-gray-200 rounded-full h-4 mb-6">
                <div className="bg-green-500 h-4 rounded-full transition-all duration-500" style={{ width: `${((idx)/questions.length)*100}%` }}></div>
            </div>

            <div className="bg-white rounded-[2rem] p-8 shadow-xl border-4 border-green-100 relative overflow-hidden">
                {/* Feedback Overlay */}
                {feedback && (
                    <div className={`absolute inset-0 flex flex-col items-center justify-center z-10 bg-opacity-95 ${feedback === 'correct' ? 'bg-green-100' : 'bg-red-100'}`}>
                        <div className={`text-9xl mb-4 ${feedback === 'correct' ? 'animate-bounce' : 'animate-pulse'}`}>
                            {feedback === 'correct' ? 'â­•' : 'âŒ'}
                        </div>
                        <h2 className={`text-4xl font-bold ${feedback === 'correct' ? 'text-green-600' : 'text-red-600'}`}>
                            {feedback === 'correct' ? 'å¤ªæ£’äº†ï¼ç­”å°äº†ï¼' : 'å“å‘€ï¼Œå†æƒ³ä¸€ä¸‹ï¼'}
                        </h2>
                        <p className="text-2xl mt-4 text-gray-700 px-8 text-center">{q.explanation}</p>
                    </div>
                )}

                <div className="flex justify-between items-center mb-6">
                    <span className="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg font-bold text-xl">
                        Q{idx + 1} / {questions.length} - {q.category}
                    </span>
                </div>

                <h3 className="text-med font-bold text-gray-800 mb-10 leading-relaxed">
                    {q.question}
                </h3>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {q.options.map((opt, i) => (
                        <button
                            key={i}
                            onClick={() => handleAnswer(opt)}
                            className="bg-white border-4 border-gray-200 hover:border-blue-400 hover:bg-blue-50 text-gray-700 font-bold text-2xl md:text-3xl py-8 px-4 rounded-2xl btn-interact text-center"
                        >
                            {opt}
                        </button>
                    ))}
                </div>
            </div>
            
            <button onClick={onBack} className="mt-8 text-gray-500 text-xl underline self-center">
                æš«åœï¼Œå›é¸å–®
            </button>
        </div>
    );
};

const ResultScreen = ({ score, total, history, onRestart, onUpload, uploadStatus, studentName }) => {
    return (
        <div className="w-full max-w-3xl flex flex-col items-center fade-in pb-10">
            <div className="relative">
                <Award size={120} className="text-yellow-500 mb-4 animate-bounce" />
                <div className="absolute top-0 right-0 -mr-4 mt-2">âœ¨</div>
                <div className="absolute bottom-0 left-0 -ml-4 mb-2">ğŸ‰</div>
            </div>
            
            <h2 className="text-5xl font-bold text-gray-800 mb-2">æ­å–œå®Œæˆï¼</h2>
            <p className="text-2xl text-gray-600 mb-8">{studentName}ï¼Œä½ çš„è¡¨ç¾å¤ªæ£’äº†ï¼</p>
            
            <div className="bg-white p-8 rounded-3xl shadow-xl border-4 border-yellow-400 w-full text-center mb-8">
                <div className="text-2xl text-gray-500 mb-2">æœ¬æ¬¡å¾—åˆ†</div>
                <div className="text-8xl font-black text-red-500">{score}</div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full mb-8">
                <button 
                    onClick={onUpload}
                    disabled={uploadStatus === 'success' || uploadStatus === 'uploading'}
                    className={`py-4 px-6 rounded-2xl text-2xl font-bold flex items-center justify-center gap-2 btn-interact ${
                        uploadStatus === 'success' ? 'bg-green-500 text-white' : 
                        uploadStatus === 'uploading' ? 'bg-gray-400 text-white cursor-wait' :
                        'bg-blue-600 text-white'
                    }`}
                >
                    {uploadStatus === 'idle' && <><UploadCloud size={32} /> ä¸Šå‚³æˆç¸¾çµ¦è€å¸«</>}
                    {uploadStatus === 'uploading' && <>ä¸Šå‚³ä¸­...</>}
                    {uploadStatus === 'success' && <><Check size={32} /> ä¸Šå‚³æˆåŠŸï¼</>}
                    {uploadStatus === 'error' && <><X size={32} /> ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦</>}
                </button>

                <button 
                    onClick={onRestart}
                    className="bg-yellow-400 text-yellow-900 py-4 px-6 rounded-2xl text-2xl font-bold flex items-center justify-center gap-2 btn-interact"
                >
                    <RotateCcw size={32} /> å†æŒ‘æˆ°ä¸€æ¬¡
                </button>
            </div>

            {/* å»¶ä¼¸å°ä»»å‹™ */}
            <div className="w-full bg-pink-50 border-4 border-pink-200 p-6 rounded-2xl mb-8">
                <h3 className="text-2xl font-bold text-pink-600 mb-4">ğŸŒŸ èª²å¾Œå°ä»»å‹™</h3>
                <p className="text-xl text-gray-700 mb-4">è«‹å®Œæˆé€™å¥è©±ä¸¦è·ŸåŒå­¸åˆ†äº«ï¼š</p>
                <div className="bg-white p-4 rounded-xl text-xl leading-relaxed font-bold text-gray-600">
                    ã€Œæˆ‘å¿ƒä¸­çš„é™½å…‰æ˜¯
                    <input className="border-b-2 border-gray-400 w-24 mx-2 text-center text-blue-600 focus:outline-none" placeholder="é¡è‰²" />
                    è‰²çš„ï¼Œå› ç‚º
                    <input className="border-b-2 border-gray-400 w-full mt-2 text-blue-600 focus:outline-none" placeholder="å¯«ä¸‹ä½ çš„åŸå› ..." />ã€‚ã€
                </div>
            </div>

            {/* è©³ç´°æª¢è¨ */}
            <div className="w-full">
                <h3 className="text-2xl font-bold text-gray-700 mb-4">ğŸ“ ç­”é¡Œæª¢è¨</h3>
                <div className="space-y-4">
                    {history.map((h, i) => (
                        <div key={i} className={`p-4 rounded-xl border-l-8 ${h.correct ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'} shadow-sm`}>
                            <div className="flex items-start gap-3">
                                <div className="mt-1 text-2xl">{h.correct ? 'â­•' : 'âŒ'}</div>
                                <div>
                                    <p className="font-bold text-lg text-gray-800">{h.question}</p>
                                    <p className="text-gray-600 mt-1">
                                        ä½ çš„ç­”æ¡ˆï¼š<span className={h.correct ? 'text-green-600' : 'text-red-600 font-bold'}>{h.userAns}</span>
                                    </p>
                                    {!h.correct && (
                                        <p className="text-green-600 mt-1 font-bold">æ­£ç¢ºç­”æ¡ˆï¼š{h.correctAns}</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

// --- ä¸»ç¨‹å¼å…ƒä»¶ ---
export default function App() {
    const [view, setView] = useState('login'); // login, menu, video, study, quiz, result
    const [studentName, setStudentName] = useState('');
    const [quizState, setQuizState] = useState({
        currentQ: 0,
        score: 0,
        history: [], // { q: string, correct: boolean }
        completed: false
    });
    const [localHistory, setLocalHistory] = useState([]);
    const [uploadStatus, setUploadStatus] = useState(''); // idle, uploading, success, error

    // åˆå§‹åŒ–è®€å–æ­·å²ç´€éŒ„
    useEffect(() => {
        const saved = localStorage.getItem('sunlight_lesson_history');
        if (saved) {
            try {
                setLocalHistory(JSON.parse(saved));
            } catch(e) {}
        }
    }, []);

    const handleLogin = (name) => {
        if(!name.trim()) return alert("è«‹è¼¸å…¥åå­—å–”ï¼");
        setStudentName(name);
        setView('menu');
    };

    const saveRecord = (finalScore, detailHistory) => {
        const record = {
            date: new Date().toLocaleString(),
            name: studentName,
            score: finalScore,
            details: detailHistory
        };
        const newHistory = [record, ...localHistory];
        setLocalHistory(newHistory);
        localStorage.setItem('sunlight_lesson_history', JSON.stringify(newHistory));
        return record;
    };

    const uploadToGoogle = async (record) => {
        setUploadStatus('uploading');
        const formData = new FormData();
        formData.append('name', record.name);
        formData.append('score', record.score);
        formData.append('date', record.date);
        formData.append('detail', JSON.stringify(record.details.map(d => d.correct ? 'O' : 'X')));

        try {
            // ä½¿ç”¨ no-cors æ¨¡å¼ç™¼é€ï¼Œå› ç‚ºé€šå¸¸ Apps Script ä¸æœƒè¨­å®šè¤‡é›œçš„ CORS headers
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: formData,
                mode: 'no-cors' 
            });
            // ç”±æ–¼ no-cors ä¸æœƒå›å‚³ readable responseï¼Œæˆ‘å€‘å‡è¨­åªè¦æ²’æ‹‹å‡ºéŒ¯èª¤å°±æ˜¯æˆåŠŸé€å‡º
            setUploadStatus('success');
            setTimeout(() => setUploadStatus('idle'), 3000);
        } catch (error) {
            console.error("Upload failed", error);
            setUploadStatus('error');
        }
    };

    // æ¸²æŸ“è¦–åœ–åˆ‡æ›
    return (
        <div className="min-h-screen w-full max-w-4xl mx-auto bg-white shadow-2xl overflow-hidden relative font-sans">
            <GlobalStyles />
            {/* Header */}
            <header className="bg-yellow-400 p-4 border-b-4 border-yellow-600 flex justify-between items-center z-10 relative">
                <div className="flex items-center gap-3">
                    <div className="bg-white p-2 rounded-full border-2 border-orange-500">
                        <Sun size={32} color="#F59E0B" className="animate-spin-slow" />
                    </div>
                    <h1 className="text-2xl md:text-3xl font-bold text-gray-800 tracking-wider">è‰²é¦™å‘³çš„é™½å…‰</h1>
                </div>
                {studentName && (
                    <div className="bg-white px-4 py-2 rounded-xl border-2 border-yellow-600 font-bold text-lg text-yellow-800">
                        ğŸ‘¤ {studentName}
                    </div>
                )}
            </header>

            {/* Content Area */}
            <main className="p-4 md:p-8 min-h-[80vh] flex flex-col items-center justify-center relative">
                {view === 'login' && <LoginScreen onLogin={handleLogin} />}
                {view === 'menu' && <MainMenu setView={setView} localHistory={localHistory} studentName={studentName}/>}
                {view === 'video' && <VideoSection onBack={() => setView('menu')} />}
                {view === 'study' && <StudySection onBack={() => setView('menu')} />}
                {view === 'quiz' && <QuizSection 
                    questions={quizData} 
                    onComplete={(score, history) => {
                        const record = saveRecord(score, history);
                        setQuizState({ score, history, completed: true });
                        setView('result');
                    }} 
                    onBack={() => setView('menu')}
                />}
                {view === 'result' && <ResultScreen 
                    score={quizState.score} 
                    total={quizData.length}
                    history={quizState.history}
                    studentName={studentName}
                    onUpload={() => uploadToGoogle({
                        name: studentName,
                        score: quizState.score,
                        date: new Date().toLocaleString(),
                        details: quizState.history
                    })}
                    uploadStatus={uploadStatus}
                    onRestart={() => setView('menu')}
                />}
            </main>

            {/* Footer decoration */}
            <div className="absolute bottom-0 left-0 w-full h-4 bg-gradient-to-r from-green-400 via-yellow-400 to-blue-400"></div>
        </div>
    );
};
